{% extends "baseAdmin.html" %}

{% block title %}Historial de {{ paciente.nombre }}{% endblock %}

{% block page_title %}
    <i class="fas fa-file-medical"></i> Historial Clínico: {{ paciente.nombre }}
{% endblock %}

{% block admin_content %}
<style>
    /* Estilos específicos para la página de historial */
    .patient-info {
        padding: 20px;
        background: #f8fafc;
        border: 1px solid var(--color-borde);
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    .info-item { display: flex; flex-direction: column; }
    .info-label { font-weight: 600; color: #64748b; font-size: 12px; text-transform: uppercase; }
    .info-value { color: var(--color-texto); font-size: 14px; }

    .tabs {
        display: flex;
        border-bottom: 1px solid var(--color-borde);
        margin-bottom: 20px;
    }
    .tabs button {
        background: transparent;
        color: #64748b;
        border: none;
        padding: 12px 20px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }
    .tabs button.active {
        color: var(--color-principal);
        border-bottom-color: var(--color-principal);
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .section-title { color: var(--color-sidebar); font-size: 20px; }

    .consultas-list { display: flex; flex-direction: column; gap: 12px; }
    .consulta-item {
        background: white;
        border: 1px solid var(--color-borde);
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .consulta-item:hover { border-color: var(--color-principal); transform: translateX(2px); }
    .consulta-item.highlight { background: #fffae6; border-left: 4px solid #f39c12; }

    /* Estilos de la galería de archivos */
    .form-section, .gallery-section { margin-bottom: 30px; }
    .form-section h3, .gallery-section h3 { color: var(--color-sidebar); margin-bottom: 15px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
    .form-group textarea, .form-group input[type="file"] { width: 100%; padding: 10px; border: 1px solid var(--color-borde); border-radius: 6px; }
    .btn-submit { float: right; }
    
    .file-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
    .file-card { background-color: #f8fafc; border: 1px solid var(--color-borde); border-radius: 8px; padding: 15px; text-align: center; }
    .file-icon { font-size: 48px; color: var(--color-principal); margin-bottom: 10px; }
    .file-icon .fa-file-pdf { color: #e74c3c; }
    .file-icon .fa-file-image { color: #27ae60; }
    .file-name { font-size: 13px; font-weight: 500; word-break: break-all; margin-bottom: 10px; }
    .file-actions { display: flex; justify-content: center; gap: 10px; }
    .action-btn { background: none; border: 1px solid #ccc; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; }

</style>

<div class="patient-info">
    <div class="info-grid">
        <div class="info-item"><span class="info-label">Cédula</span><span class="info-value">{{ paciente.cedula }}</span></div>
        <div class="info-item"><span class="info-label">Nacimiento</span><span class="info-value">{{ paciente.nacimiento }}</span></div>
        <div class="info-item"><span class="info-label">Teléfono</span><span class="info-value">{{ paciente.telefono }}</span></div>
    </div>
</div>

<div class="tabs">
    <button class="active" onclick="showTab('consultas', this)">Consultas</button>
    <button onclick="showTab('historial', this)">Historial y Archivos</button>
</div>

<div id="consultas" class="tab-content active">
    <div class="section-header">
        <h3 class="section-title">Consultas Médicas</h3>
        <button class="btn btn-primary" onclick="nuevaConsulta()">+ Nueva Consulta</button>
    </div>
    <div class="consultas-list">
        {% if consultas and consultas|length > 0 %}
            {% for c in consultas %}
                <div id="consulta-{{ c.id }}"
                     class="consulta-item {% if c.id == last_consulta_id %}highlight{% endif %}"
                     onclick="verConsulta({{ c.id }})">
                    <strong>{{ c.fecha.strftime('%d/%m/%Y') }}</strong> — {{ c.diagnostico or 'Consulta General' }}
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state"><p>No hay consultas registradas.</p></div>
        {% endif %}
    </div>
</div>

<div id="historial" class="tab-content">
    <div class="form-section">
        <h3>Actualizar Historial y Adjuntar Archivos</h3>
        <form method="POST" action="{{ url_for('actualizar_historial', historial_id=historial.id) }}" enctype="multipart/form-data">
            <input type="hidden" name="paciente_id" value="{{ paciente.id }}">
            <div class="form-group"><label>Antecedentes Familiares</label><textarea name="antecedentes" rows="3">{{ historial.antecedentes_familiares or '' }}</textarea></div>
            <div class="form-group"><label>Medicación Actual</label><textarea name="medicacion" rows="3">{{ historial.medicacion or '' }}</textarea></div>
            <div class="form-group"><label>Adjuntar Nuevo Archivo</label><input type="file" name="file" class="input-file"></div>
            <button type="submit" class="btn btn-primary btn-submit">Guardar Cambios</button>
        </form>
    </div>

    <div class="gallery-section">
        <h3>Archivos Adjuntos</h3>
        {% if archivos and archivos|length > 0 %}
            <div class="file-gallery">
                {% for archivo in archivos %}
                <div class="file-card">
                    <div class="file-icon">
                        {% if archivo.filename.lower().endswith('.pdf') %}<i class="fas fa-file-pdf"></i>
                        {% elif archivo.filename.lower().endswith(('.png', '.jpg', '.jpeg')) %}<i class="fas fa-file-image"></i>
                        {% else %}<i class="fas fa-file-alt"></i>{% endif %}
                    </div>
                    <div class="file-name" title="{{ archivo.filename }}">{{ archivo.filename }}</div>
                    <div class="file-actions">
                        <a href="{{ url_for('ver_archivo', filename=archivo.filename) }}" target="_blank" class="action-btn view-btn"><i class="fas fa-eye"></i></a>
                        <button onclick="deleteFile({{ archivo.id }})" class="action-btn delete-btn"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state"><p>No hay archivos adjuntos.</p></div>
        {% endif %}
    </div>
</div>

<script>    
    function nuevaConsulta() { window.location.href = `/paciente/{{ paciente.id }}/historial/consulta`; }
    function verConsulta(id) { window.location.href = `/paciente/{{ paciente.id }}/historial/${id}`; }

    function showTab(tabId, element) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tabs button').forEach(button => button.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        element.classList.add('active');
    }

    function deleteFile(fileId) {
        if (confirm('¿Estás seguro de que quieres eliminar este archivo?')) {
            fetch(`/historial/{{historial.id}}/file/${fileId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Archivo eliminado.');
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const lastConsulta = document.querySelector('.consulta-item.highlight');
        if (lastConsulta) {
            lastConsulta.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => { lastConsulta.classList.remove('highlight'); }, 2500);
        }
    });
</script>
{% endblock %}