{% extends "baseAdmin.html" %}

{% block title %}Nueva Consulta - {{ paciente.nombre }}{% endblock %}

{% block page_title %}
    <i class="fas fa-stethoscope"></i> Nueva Consulta para: {{ paciente.nombre }}
{% endblock %}

{% block admin_content %}
<style>
    /* Estilos específicos para esta página */
    .patient-info-panel {
        background-color: #f8fafc;
        border: 1px solid var(--color-borde);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .patient-summary {
        display: flex; flex-wrap: wrap; gap: 20px;
        color: var(--color-texto); font-size: 14px;
    }
    .patient-summary span { display: flex; align-items: center; gap: 5px; }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    .form-group { display: flex; flex-direction: column; }
    .form-group.full-width { grid-column: 1 / -1; }
    .form-group label { font-weight: bold; margin-bottom: 8px; color: var(--color-texto); }
    .form-group input, .form-group textarea, .form-group select {
        padding: 12px; border: 1px solid var(--color-borde); border-radius: 8px; font-size: 16px;
    }
    .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--color-borde); }
    .message { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
    .message.error { background: #f8d7da; color: #721c24; }
</style>

<div class="patient-info-panel">
    <div class="patient-summary" id="patientSummary">
        <span><strong>Paciente:</strong> {{ paciente.nombre }}</span>
        <span><strong>Cédula:</strong> {{ paciente.cedula }}</span>
        <span><strong>Teléfono:</strong> {{ paciente.telefono }}</span>
    </div>
</div>

<div class="message error" id="errorMessage"></div>

<form id="consultaForm">
    <div class="form-grid">
        <div class="form-group">
            <label for="fecha">Fecha de Consulta</label>
            <input type="date" id="fecha" name="fecha" required>
        </div>
        <div class="form-group">
            <label for="presion_arterial">Presión Arterial</label>
            <input type="text" id="presion_arterial" name="presion_arterial" placeholder="Ej: 120/80">
        </div>
        <div class="form-group">
            <label for="diagnostico">Diagnóstico</label>
            <input type="text" id="diagnostico" name="diagnostico" placeholder="Diagnóstico principal" maxlength="200">
        </div>
    </div>
    <div class="form-group full-width">
        <label for="notas">Notas y Observaciones</label>
        <textarea id="notas" name="notas" placeholder="Observaciones adicionales, síntomas, recomendaciones..." rows="5"></textarea>
    </div>

    <input type="hidden" name="historial_clinico_id" value="{{ historial.id }}">
    <input type="hidden" name="doctor_id" value="{{ current_user.persona_id if current_user and current_user.persona_id else 1 }}"> <div class="form-actions">
        <button type="button" class="btn btn-back" onclick="window.history.back()">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar Consulta</button>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha').value = today;
    });

    document.getElementById('consultaForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const patientId = '{{ paciente.id }}';
        const formData = new FormData(e.target);
        const payload = Object.fromEntries(formData.entries());
        payload.paciente_id = patientId;
        
        fetch('/api/consulta', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(resp => resp.json())
        .then(data => {
            if (data.success) {
                window.location.href = `/historial?patientId=${patientId}&last_consulta_id=${data.consulta_id}`;
            } else {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = 'Error: ' + (data.error || 'Desconocido');
                errorDiv.style.display = 'block';
            }
        });
    });
</script>
{% endblock %}