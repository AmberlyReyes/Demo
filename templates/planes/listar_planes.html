{% extends "baseAdmin.html" %}

{% block title %}Planes de Tratamiento - {{ paciente.nombre }}{% endblock %}
{% block page_title %}Planes de Tratamiento: {{ paciente.nombre }}{% endblock %}

{% block admin_content %}
<style>
    .table-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--color-borde); }
    .data-table th { background-color: #f8fafc; font-size: 14px; text-transform: uppercase; color: #64748b; }
    .data-table .actions a, .data-table .actions button { margin-right: 10px; color: var(--color-secundario); background:none; border:none; cursor:pointer; padding:0; }
    .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; }
    .status-activo { background-color: #27ae60; }
    .status-presupuesto { background-color: #f39c12; }
    .status-finalizado { background-color: #6c757d; }
    .empty-state { text-align: center; padding: 40px; color: #666; }
    a {
    text-decoration: none;
 }
    
</style>

<div class="table-actions">
    <p>Visualiza y gestiona todos los planes de tratamiento asociados a este paciente.</p>
    <a href="{{ url_for('crear_plan_paciente', paciente_id=paciente.id) }}" class="btn btn-primary"><i class="fas fa-plus"></i> Crear Nuevo Plan</a>
</div>

{% if planes and planes|length > 0 %}
<table class="data-table">
    <thead>
        <tr>
            <th>Nombre del Plan</th>
            <th>Doctor Asignado</th>
            <th>Fecha de Inicio</th>
            <th>Costo Total</th>
            <th>Estado</th>
            <th class="actions">Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for plan in planes %}
        <tr>
            <td>{{ plan.nombre_plan }}</td>
            <td>{{ plan.doctor.nombre }}</td>
            <td>{{ plan.fecha_inicio.strftime('%d/%m/%Y') }}</td>
            <td>${{ "%.2f"|format(plan.costo_total) }}</td>
            <td>
                <span class="status-badge 
                    {% if plan.estado == 'Activo' %}status-activo
                    {% elif plan.estado == 'Presupuesto' %}status-presupuesto
                    {% else %}status-finalizado{% endif %}">
                    {{ plan.estado }}
                </span>
            </td>
            <td class="actions">
                <a href="{{ url_for('ver_plan_paciente', paciente_id=paciente.id, plan_id=plan.id) }}" title="Ver Detalles">
                  <i class="fas fa-eye"></i>
                </a>
                <a href="{{ url_for('editar_plan_paciente', paciente_id=paciente.id, plan_id=plan.id) }}" title="Editar Plan">
                  <i class="fas fa-edit"></i>
                </a>
                <a href="javascript:void(0)" 
                   onclick="mostrarOpcionesImpresion({{ plan.id }})" 
                   title="Imprimir Plan">
                  <i class="fas fa-print"></i>
                </a>
                <form action="{{ url_for('eliminar_plan_paciente', paciente_id=paciente.id, plan_id=plan.id) }}"
                      method="post" style="display:inline">
                  <button type="submit"
                          onclick="return confirm('¿Eliminar este plan?')"
                          title="Eliminar Plan">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty-state">
    <h4>Este paciente aún no tiene planes de tratamiento.</h4>
    <p>Haz clic en "Crear Nuevo Plan" para empezar.</p>
</div>
{% endif %}

<!-- Paginación -->
<div style="text-align: center; margin-top: 25px;">
{% if planes_paginados.pages > 1 %}
    {% if planes_paginados.has_prev %}
        <a href="{{ url_for('listar_planes_paciente', paciente_id=paciente.id, page=planes_paginados.prev_num) }}" style="margin: 0 5px; text-decoration: none; color: var(--color-principal);">&laquo; Anterior</a>
    {% endif %}

    {% for page_num in planes_paginados.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
        {% if page_num %}
            {% if page_num != planes_paginados.page %}
                <a href="{{ url_for('listar_planes_paciente', paciente_id=paciente.id, page=page_num) }}" style="margin: 0 5px; text-decoration: none;">{{ page_num }}</a>
            {% else %}
                <strong style="margin: 0 5px;">{{ page_num }}</strong>
            {% endif %}
        {% else %}
            <span style="margin: 0 5px;">...</span>
        {% endif %}
    {% endfor %}
    
    {% if planes_paginados.has_next %}
        <a href="{{ url_for('listar_planes_paciente', paciente_id=paciente.id, page=planes_paginados.next_num) }}" style="margin: 0 5px; text-decoration: none; color: var(--color-principal);">Siguiente &raquo;</a>
    {% endif %}
{% endif %}
</div>

<!-- Modal para opciones de impresión -->
<div id="modalImpresion" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: none; border-radius: 10px; width: 400px; text-align: center;">
        <h3 style="color: #333; margin-bottom: 20px;">Opciones de Impresión</h3>
        <p style="color: #666; margin-bottom: 30px;">¿Qué tipo de plan deseas imprimir?</p>
        
        <div style="margin-bottom: 20px; display: flex; justify-content: center; gap: 10px;">
            <button onclick="imprimirPlan('completo')" 
                    class="btn btn-primary" 
                    style="background-color: #007bff; padding: 10px 20px;">
                <i class="fas fa-dollar-sign"></i> Con Precios
            </button>
            
            <button onclick="imprimirPlan('simple')" 
                    class="btn btn-primary" 
                    style="background-color: #17a2b8; padding: 10px 20px;">
                <i class="fas fa-list"></i> Solo detalle
            </button>
        </div>
        
        <button onclick="cerrarModal()" 
                class="btn btn-secondary" 
                style="background-color: #6c757d; padding: 8px 15px;">
            Cancelar
        </button>
    </div>
</div>

<script>
let planSeleccionado = null;

function mostrarOpcionesImpresion(planId) {
    planSeleccionado = planId;
    document.getElementById('modalImpresion').style.display = 'block';
}

function cerrarModal() {
    document.getElementById('modalImpresion').style.display = 'none';
    planSeleccionado = null;
}

function imprimirPlan(tipo) {
    if (planSeleccionado) {
        const url = `/plan/${planSeleccionado}/imprimir/${tipo}`;
        const ventana = window.open(url, 'imprimir_plan', 'width=800,height=600,scrollbars=yes,resizable=yes');
        
        if (ventana) {
            ventana.focus();
        }
    }
    
    cerrarModal();
}

// Cerrar modal al hacer click fuera de él
window.onclick = function(event) {
    const modal = document.getElementById('modalImpresion');
    if (event.target == modal) {
        cerrarModal();
    }
}
</script>
{% endblock %}